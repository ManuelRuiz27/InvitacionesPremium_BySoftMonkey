<div class="delivery-panel">
  <div class="header">
    <div class="header-title">
      <p class="eyebrow">Bloque 1.5</p>
      <h2>
        <mat-icon>send</mat-icon>
        Panel de envío manual
      </h2>
      <p class="hint">Última actualización {{ getLastUpdatedCopy() }} · {{ refreshLabel }}</p>
    </div>

    <div class="header-actions">
      <button mat-stroked-button type="button" (click)="refreshAll()">
        <mat-icon>autorenew</mat-icon>
        Actualizar ahora
      </button>
      <button mat-icon-button (click)="close()">
        <mat-icon>close</mat-icon>
      </button>
    </div>
  </div>

  <div class="alert-banner" *ngIf="failureAlertActive">
    <mat-icon>warning</mat-icon>
    <div>
      <p>Detectamos {{ failureRateLabel }} de fallas.</p>
      <span>Revisa los números de contacto y vuelve a intentar para evitar bloquear el evento.</span>
    </div>
  </div>

  <div class="stats-section" [class.loading]="statsLoading">
    <div class="stat-card">
      <mat-icon>email</mat-icon>
      <div class="stat-content">
        <span class="stat-value">{{ stats.total }}</span>
        <span class="stat-label">Total</span>
      </div>
    </div>
    <div class="stat-card success">
      <mat-icon>check_circle</mat-icon>
      <div class="stat-content">
        <span class="stat-value">{{ stats.sent }}</span>
        <span class="stat-label">Enviados</span>
      </div>
    </div>
    <div class="stat-card warning">
      <mat-icon>schedule</mat-icon>
      <div class="stat-content">
        <span class="stat-value">{{ stats.pending }}</span>
        <span class="stat-label">Pendientes</span>
      </div>
    </div>
    <div class="stat-card error">
      <mat-icon>error</mat-icon>
      <div class="stat-content">
        <span class="stat-value">{{ stats.failed }}</span>
        <span class="stat-label">Fallidos</span>
      </div>
    </div>
    <div class="stat-card">
      <mat-icon>percent</mat-icon>
      <div class="stat-content">
        <span class="stat-value">{{ stats.successRate | number:'1.0-0' }}%</span>
        <span class="stat-label">Éxito</span>
      </div>
    </div>
  </div>

  <div class="channel-section">
    <div class="channel-card" *ngFor="let channel of channelBreakdown">
      <div class="channel-header">
        <mat-icon>{{ getMethodIcon(channel.channel) }}</mat-icon>
        <strong>{{ channel.channel }}</strong>
      </div>
      <div class="channel-body">
        <p><span>{{ channel.sent }}</span> Enviados</p>
        <p><span>{{ channel.pending }}</span> Pendientes</p>
        <p><span>{{ channel.failed }}</span> Fallidos</p>
      </div>
    </div>
    <div class="history-card" *ngIf="history.length">
      <h3>Últimos envíos</h3>
      <ul>
        <li *ngFor="let point of history">
          <span>{{ point.timestamp | date:'shortTime' }}</span>
          <span>{{ point.sent }} enviados · {{ point.failed }} fallidos</span>
        </li>
      </ul>
    </div>
  </div>

  <div class="actions-section">
    <mat-form-field appearance="outline" class="method-selector">
      <mat-label>Método de envío</mat-label>
      <mat-select [(ngModel)]="selectedMethod">
        <mat-option value="WHATSAPP">
          <mat-icon>chat</mat-icon>
          WhatsApp (recomendado)
        </mat-option>
        <mat-option value="SMS">
          <mat-icon>sms</mat-icon>
          SMS
        </mat-option>
      </mat-select>
    </mat-form-field>

    <button mat-raised-button color="primary" (click)="sendInvitations()" [disabled]="sending || isSelectionEmpty">
      <mat-icon>{{ sending ? 'hourglass_top' : 'send' }}</mat-icon>
      {{ sending ? 'Enviando...' : 'Enviar invitaciones' }}
    </button>

    <span class="selection-info" [class.warning]="isSelectionEmpty">
      {{ isSelectionEmpty ? 'No hay invitaciones seleccionadas' : data.invitationIds.length + ' invitaciones seleccionadas' }}
    </span>
  </div>

  <div class="table-section">
    <div class="table-header">
      <h3>Resultados del envío</h3>
      <button mat-button type="button" (click)="refreshAll()">
        <mat-icon>refresh</mat-icon>
        Actualizar tabla
      </button>
    </div>

    <div class="loading-container" *ngIf="attemptsLoading">
      <mat-spinner diameter="40"></mat-spinner>
      <p>Cargando resultados...</p>
    </div>

    <table mat-table [dataSource]="attempts" *ngIf="!attemptsLoading && hasAttempts">
      <ng-container matColumnDef="guest">
        <th mat-header-cell *matHeaderCellDef>Invitado</th>
        <td mat-cell *matCellDef="let attempt">
          <div class="guest-cell">
            <strong>{{ attempt.guestName }}</strong>
            <span>{{ attempt.phone }}</span>
          </div>
        </td>
      </ng-container>

      <ng-container matColumnDef="method">
        <th mat-header-cell *matHeaderCellDef>Método</th>
        <td mat-cell *matCellDef="let attempt">
          <mat-chip [class]="'chip-' + attempt.channel.toLowerCase()">
            <mat-icon>{{ getMethodIcon(attempt.channel) }}</mat-icon>
            {{ attempt.channel }}
          </mat-chip>
        </td>
      </ng-container>

      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef>Estado</th>
        <td mat-cell *matCellDef="let attempt">
          <mat-chip [class]="'chip-' + getStatusClass(attempt.status)">
            <mat-icon>{{ getStatusIcon(attempt.status) }}</mat-icon>
            {{ attempt.status }}
          </mat-chip>
          <span class="error-message" *ngIf="attempt.errorMessage">{{ attempt.errorMessage }}</span>
        </td>
      </ng-container>

      <ng-container matColumnDef="attempts">
        <th mat-header-cell *matHeaderCellDef>Intentos</th>
        <td mat-cell *matCellDef="let attempt">
          {{ attempt.providerMessageId ? 1 : 0 }}
        </td>
      </ng-container>

      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef>Acciones</th>
        <td mat-cell *matCellDef="let attempt">
          <button mat-icon-button matTooltip="Reintentar envío" *ngIf="attempt.status === 'FAILED'" (click)="retryDelivery(attempt.invitationId)" [disabled]="isRetrying(attempt.invitationId)">
            <mat-icon>{{ isRetrying(attempt.invitationId) ? 'hourglass_empty' : 'refresh' }}</mat-icon>
          </button>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns; trackBy: trackByAttempt"></tr>
    </table>

    <div class="empty-state" *ngIf="!attemptsLoading && !hasAttempts">
      <mat-icon>inbox</mat-icon>
      <p>No hay envíos registrados.</p>
      <p class="hint">Haz clic en “Enviar invitaciones” cuando estés listo. Nada se envía sin tu confirmación.</p>
    </div>
  </div>
</div>
